<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Profile</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<script src="/js/profile.js"></script>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>

    <main class="main">
      <div class="profile-container">
        <form action="/profile/update" method="POST" enctype="multipart/form-data">
        <!-- ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ìƒë‹¨ ì˜ì—­ -->
        <div class="profile-header">
          <div class="profile-avatar-wrapper">
            <img class="profile-avatar" src="<%= (user.profile_image && user.profile_image !== 'null' && user.profile_image.trim?.() !== '') ? user.profile_image : '/img/profile_user.jpg' %>" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
            <label for="profileUpload" class="camera-icon">
              <img src="/img/camera.png" alt="ì¹´ë©”ë¼ ì•„ì´ì½˜" />
            </label>
            <input type="file" name="profile_image" id="profileUpload" accept="image/png, image/jpeg" hidden />
          </div>
          <div class="profile-info">
            <div class="profile-username"><%= user.name %></div>
            <div class="profile-email"><%= user.email %></div>
          </div>
        </div>

        <!--í”„ë¡œí•„ ìˆ˜ì • í¼ -->
          <div class="profile-field">
            <label>ì•„ì´ë””</label>
            <input type="text" value="<%= user.id %>" disabled />
          </div>

          <div class="profile-field">
            <label>ì´ë¦„</label>
            <input type="text" name="name" value="<%= user.name %>" required />
          </div>

          <div class="profile-field">
            <label>ì „í™”ë²ˆí˜¸</label>
            <input type="tel" name="phone" value="<%= user.phone %>" required />
          </div>

          <% if (!isSocial) { %>
            <div class="profile-field">
              <label>ì´ë©”ì¼</label>
              <input type="email" name="email" value="<%= user.email %>" required />
            </div>
          <% } else { %>
            <div class="profile-field">
              <label>ì´ë©”ì¼</label>
              <input type="email" value="<%= user.email %>" disabled />
              <!-- ìˆ˜ì • ë¶ˆê°€í•˜ë˜ ì„œë²„ì— ê°’ì€ ì „ë‹¬ -->
              <input type="hidden" name="email" value="<%= user.email %>" />
            </div>
          <% } %>


          <div class="profile-field">
            <label>ì„±ë³„</label>
            <select name="gender">
              <option value="M" <%= user.gender === 'M' ? 'selected' : '' %>>ë‚¨ì„±</option>
              <option value="F" <%= user.gender === 'F' ? 'selected' : '' %>>ì—¬ì„±</option>
            </select>
          </div>

          <div class="profile-field">
            <label>ë‹‰ë„¤ì„</label>
            <input type="text" name="nickname" value="<%= user.nickname || '' %>" />
          </div>

          <% if (!isSocial) { %>
            <div class="profile-field">
              <label>ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œ ì…ë ¥)</label>
              <input type="password" name="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" />
            </div>
          <% } %>

          <button class="btn-save" type="submit">Save changes</button>
        </form>
        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("form[action='/profile/update']");
            const fileInput = document.getElementById("profileUpload");
            const profileImage = document.querySelector(".profile-avatar");
            const submitBtn = form.querySelector("button[type='submit']");

            // ì´ˆê¸°ê°’ ì €ì¥
            const originalValues = {
              name: form.name.value,
              phone: form.phone.value,
              email: form.email.value,
              nickname: form.nickname.value,
              gender: form.gender.value,
              password: '',
              imageChanged: false
            };

            // ì…ë ¥ê°’ ë³€í™” ê°ì§€
            const inputs = form.querySelectorAll("input:not([type='file']), select");
            inputs.forEach(input => {
              input.addEventListener("input", () => {
                submitBtn.disabled = !isChanged(form);
              });
            });

            // ì´ë¯¸ì§€ ë³€ê²½ ê°ì§€ ë° ë¯¸ë¦¬ë³´ê¸°
            fileInput.addEventListener("change", function () {
              const file = this.files[0];
              if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function (e) {
                  profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
                originalValues.imageChanged = true;
              }
              submitBtn.disabled = !isChanged(form);
            });

            // ë³€ê²½ ì—¬ë¶€ íŒë‹¨
            function isChanged(form) {
              return (
                form.name.value !== originalValues.name ||
                form.phone.value !== originalValues.phone ||
                form.email.value !== originalValues.email ||
                form.nickname.value !== originalValues.nickname ||
                form.gender.value !== originalValues.gender ||
                (form.password && form.password.value.trim() !== "") ||
                originalValues.imageChanged
              );
            }

            // ì €ì¥ ë²„íŠ¼ ì´ˆê¸° ë¹„í™œì„±í™”
            submitBtn.disabled = true;

            // ìœ íš¨ì„± ê²€ì‚¬
            function validateProfileForm() {
              const name = form.name.value.trim();
              const phone = form.phone.value.trim();
              const email = form.email.value.trim();
              const gender = form.gender.value;
              const password = form.password?.value.trim();

              const phoneRegex = /^01[0-9]-?\d{3,4}-?\d{4}$/;
              const passwordRegex = /^.{6,}$/;
              const nameRegex = /^[ê°€-í£a-zA-Z\s]{2,}$/;
              const emailRegex = /^[^\s@]+@[^\s@]+$/;

              if (!nameRegex.test(name)) {
                alert("ì´ë¦„ì€ í•œê¸€ ë˜ëŠ” ì˜ë¬¸ìœ¼ë¡œ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
              }

              if (!phoneRegex.test(phone)) {
                alert("ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: 010-1234-5678");
                return false;
              }

              if (!emailRegex.test(email)) {
                alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
              }

              if (!["M", "F"].includes(gender)) {
                alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
              }

              if (password && !passwordRegex.test(password)) {
                alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return false;
              }

              return true;
            }

            // í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬
            form.addEventListener("submit", function (e) {
              if (!validateProfileForm()) {
                e.preventDefault();
              }
            });
          });
        </script>
        <% if (mustChangePhone) { %>
          <script>
            alert("âš ï¸ ì „í™”ë²ˆí˜¸ë¥¼ ìˆ˜ì •í•´ì•¼ ëª¨ë“  ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          </script>
        <% } %>

      </div>
    </main>
  </div>
</body>
</html>
