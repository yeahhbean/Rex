require("dotenv").config();
const { GoogleGenerativeAI } = require("@google/generative-ai");

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
const model = genAI.getGenerativeModel({ model: "models/gemini-2.5-flash" });

async function analyzeExpense(expense) {
  console.log("ë³´ë‚´ëŠ” expense:", expense);
  const { id, category_name, memo, amount, spent_at } = expense;

  const prompt = `
ë‹¤ìŒì€ ì‚¬ìš©ìì˜ ì†Œë¹„ ë‚´ì—­ì…ë‹ˆë‹¤.

- ì¹´í…Œê³ ë¦¬: ${category_name}
- ë©”ëª¨: ${memo}
- ê¸ˆì•¡: ${amount}ì›
- ë‚ ì§œ: ${spent_at}

ì´ ì†Œë¹„ê°€ ê°ì •ì  ì†Œë¹„ì¸ì§€ íŒë‹¨í•´ì¤˜:
1. ê°ì • ì†Œë¹„ë©´ is_emotional: true, ì•„ë‹ˆë©´ false
2. ì†Œë¹„ë¥¼ í•˜ì§€ ì•Šê±°ë‚˜ ë” ì ì€ ì†Œë¹„ë¥¼ í•  ìˆ˜ ìˆì—ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ì†Œë¹„í•œ ë‚´ì—­ì— ëŒ€í•´ì„œëŠ” ê°ì •ì  ì†Œë¹„ë¡œ íŒë‹¨í•˜ëŠ” ê²Œ ì¢‹ì•„
3. í•˜ì§€ë§Œ ì‚´ì•„ê°€ëŠ” ë° ê¼­ í•„ìš”í•œ ì†Œë¹„ë¼ë©´ ê°ì •ì  ì†Œë¹„ê°€ ì•„ë‹ˆë¼ê³  íŒë‹¨í•˜ê¸°!
- ì›¬ë§Œí•œ ê²½ì¡°ì‚¬ë¹„, ê³ ì •ì§€ì¶œ, ì£¼ê±°ë¹„, ë³‘ì›ë¹„, êµìœ¡ë¹„ ë“±ì€ ë©”ëª¨ ë‚´ìš©ì´ ì •ë‹¹í•˜ì§€ ì•Šì„ ë•Œë§Œ ê°ì •ì  ì†Œë¹„ë¼ê³  íŒë‹¨
- ë‹¤ì¹˜ê±°ë‚˜ ë³‘ì› ì¹˜ë£Œ ëª©ì ì˜ ì†Œë¹„ëŠ” ë©”ëª¨ê°€ ì•„ë¬´ë¦¬ ìœ ì¾Œí•´ë„ ê°ì •ì  ì†Œë¹„ê°€ ì•„ë‹˜. ìƒì¡´, ì¹˜ë£Œ ëª©ì  ì†Œë¹„ëŠ” í•­ìƒ is_emotional: false.
- "ë¼ë©´", "ê¹€ë°¥" ë“± ë©”ë‰´ë§Œ ë‹¨ë…ìœ¼ë¡œ ì í˜€ ìˆì–´ë„ ì¹´í…Œê³ ë¦¬ê°€ ì‹ë¹„ì´ê³  ì •ê·œ ì‹ì‚¬ë¡œ ë³´ì´ë©´ ê°ì • ì†Œë¹„ ì•„ë‹˜!
4. is_emotionalì´ trueì¸ ê²½ìš°ì—ë§Œ feedback ë¶ˆëŸ¬ì˜¤ê¸°. falseë©´ feedback í•„ìš”ì—†ì–´

feedback ì‘ì„± ì°¸ê³ ì‚¬í•­:
- ì‚¬ìš©ìì— ì†Œë¹„ì— ëŒ€í•´ í”¼ë“œë°±ì„ ì‘ì„±í•˜ì—¬ ì‚¬ìš©ìê°€ ê°ì • ì†Œë¹„ë¥¼ ì¤„ì¼ ìˆ˜ ìˆê²Œ í•˜ëŠ” ì—­í• 
- ì‚¬ìš©ìì˜ ì†Œë¹„ ê¸ˆì•¡ê³¼ ë©”ëª¨ë¥¼ ì°¸ê³ í•˜ì—¬ ê°„ë‹¨í•œ í”¼ë“œë°± ì‘ì„±
- ì¬ì¹˜ìˆëŠ” MZ ê°ì„±ì´ ë‹´ê¸´ ì§§ì€ í•œ ì¤„ í”¼ë“œë°±! ì–¸ì–´ìœ í¬, ë°ˆ, ì´ëª¨ì§€ ë“± í™œìš© ê°€ëŠ¥ (ì´ëª¨ì§€ëŠ” ë¬¸ë§¥ì— ë§ê²Œ ë‹¤ì–‘í•˜ê²Œ í™œìš©)
- ì ˆëŒ€ ì°©í•˜ê±°ë‚˜ ì¡°ì‹¬ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ ë§ê³  ê°ì • ì†Œë¹„ë¥¼ í•œ ì‚¬ìš©ìê°€ ë¼ˆ ë§ì„ ìˆ˜ ìˆëŠ” ë¬¸ì¥ìœ¼ë¡œ

ì•„ë˜ëŠ” feedback ì˜ˆì‹œ:
- â€œë‹¤ìŒ ì •ê±°ì¥ íŒŒì‚°ì…ë‹ˆë‹¤ ğŸš¨ğŸ’³â€
- â€œì‚¼ê²¹ì‚´ë³´ë‹¤ ì§€ê°‘ì´ ë” êµ¬ì›Œì¡Œì–´ìš” ğŸ”¥â€
- â€œì´ ì •ë„ë©´ ì œíŠ¸ê¸° ì‚¬ëŠ” ê²Œ ë‚«ê² ì–´ìš” âœˆï¸ğŸ’¸â€
- â€œì´ê±´ ì†Œë¹„ê°€ ì•„ë‹ˆë¼ ê°ì • í­ë°œì´ì—ˆì–´ìš” ğŸ‡ğŸ›’â€
- â€œìŠ¤íŠ¸ë ˆìŠ¤ í‘¼ ê°’ ì¹˜ê³ ëŠ” ë¹„ìŒŒë‹¤â€¦ ğŸ’¸ğŸ’¥â€
- â€œë‹¤ìŒì—” ì´ë¶ˆ ì†ì—ì„œ ì°¸ì ìš°ë¦¬â€¦ ğŸ›ï¸ğŸ¥¹â€
- â€œì´ ì •ë„ë©´ ì§€ê°‘ì´ ìš´ë‹¤ìš”â€¦ ğŸ˜­ğŸ‘›â€
- â€œê·¸ ëˆì´ë©´ ê³ ê¸° êµ¬ì› ê² ë‹¤ ğŸ”¥ğŸ¥©â€
- â€œê°ì •ì€ í’€ë ¸ëŠ”ë° í†µì¥ì€ ì–¼ì—ˆë‹¤ â„ï¸ğŸ’³â€
- â€œí—â€¦ ì´ê±´ ê±°ì˜ ì •ì„œë¹„ìš©ì´ì–ì•„ ğŸ˜®â€ğŸ’¨ğŸ§¾â€
- â€œì§„ì‹¬ ê³µí—ˆí•¨ë§Œ ë‚¨ì•˜ì„ ë“¯â€¦ ğŸ•³ï¸ğŸ§ â€
- â€œë‹¤ìŒì—” ì¿ íŒ¡ ì¥ë°”êµ¬ë‹ˆ ë§ê³  ì‚°ì±… ì–´ë•Œìš”? ğŸ›’ğŸš¶â€â™€ï¸â€
- â€œì§€ë¦„ì‹  ê°•ë¦¼ ì¸ì •... ê·¼ë° ê°”ë‹¤ê°€ ë°”ë¡œ í‡´ì¥ì‹œì¼œì•¼ í–ˆìŒ ğŸ™ƒğŸ›â€
- â€œì´ê±´ ê·¸ëƒ¥ ì§€ê°‘ìœ¼ë¡œ ìš¸ì—ˆì–´ìš” ğŸ˜­ğŸ‘â€
- â€œí…œì€ ë‚¨ì•˜ì§€ë§Œ ë‚´ ì •ì‹ ì€ ê°”ì–´ìš” ğŸ§ ğŸ’¸â€
- â€œì•„ë‹ˆ ì´ê²Œ ì™œ í•„ìš”í–ˆì£  ìš°ë¦¬...? ğŸ« ğŸ§¾â€
- â€œê·¸ ìˆœê°„ë§Œ í–‰ë³µí–ˆê³  ì§€ê¸ˆì€ ë©... ğŸ˜¶â€ğŸŒ«ï¸ğŸ“‰â€
- â€œì € ëˆì´ë©´ ë–¡ë³¶ì´ 10ë²ˆì€ ë¨¹ì—ˆê² ë‹¤ ğŸŒ¶ï¸ğŸ½ï¸â€
- â€œì§€ë¦„ì€ ìˆœê°„, ì¹´ë“œê°’ì€ ì˜ì› ğŸ’³ğŸ•°ï¸â€
- â€œì™€â€¦ ì´ê±´ í……ì¥ ëš«ê³  ë‚˜ì˜¨ ê°ì •ì´ì—ˆë‹¤ ğŸ˜¤ğŸ•³ï¸â€
- â€œì´ ì •ë„ë©´ ê°ì •+ì¶©ë™ ì½œë¼ë³´ë‹¤ ğŸ­ğŸ›ï¸â€
- â€œì´ê±´ ê°ì„± ë§ê³  ê°ì˜¥ê¸‰ ì†Œë¹„ì˜€ì–´ìš” â›“ï¸ğŸ’¸â€
- â€œìš¸ì§€ ë§ˆ ë‚´ í†µì¥â€¦ ë‹¤ìŒì—” ê¼­ ì°¸ì ğŸ¥ºğŸ“‰â€
=> ì´ëŸ° ëŠë‚Œì˜ ë¬¸ì¥ê³¼ ì†Œë¹„ ë©”ëª¨ì˜ ë‚´ìš©ì´ ì¼ë¶€ ì²¨ê°€ëœ í”¼ë“œë°± ì‘ì„± 
(ì†Œë¹„ ë©”ëª¨ ë‚´ìš© ê·¸ëŒ€ë¡œ ì‚½ì… x, ì†Œë¹„ ê¸ˆì•¡ì€ í”¼ë“œë°±ì— í¬í•¨ë˜ì§€ ì•Šì•„ë„ ë¨)


ğŸ“Œ **ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ ì •í™•í•˜ê²Œ! ì ˆëŒ€ ì„¤ëª… ë¶™ì´ì§€ ë§ˆ.**
ì˜ˆ:
{
  "is_emotional": true,
  "feedback": "ì´ê±´ ì‚¼ê²¹ì‚´ì´ ì•„ë‹ˆë¼ ì§€ê°‘ íƒœìš´ ë¶ˆíŒì´ì—ìš” ğŸ”¥ğŸ’¸"
}
`;

  try {
    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = await response.text();

    console.log("Gemini ì‘ë‹µ:\n", text);

    const cleanText = text
      .replace(/```json/gi, "")
      .replace(/```/g, "")
      .trim();

    const parsed = JSON.parse(cleanText);

    return {
      is_emotional: parsed.is_emotional || false,
      feedback: parsed.feedback || "",
    };
  } catch (err) {
    console.error("Gemini ë¶„ì„ ì¤‘ ì˜¤ë¥˜:", err);
    return {
      is_emotional: false,
      feedback: "ì˜¤ëŠ˜ì€ ë¶„ì„ë„ íœ´ê°€ë„¤ìš” â˜ï¸",
    };
  }
}

module.exports = {
  analyzeExpense,
};
